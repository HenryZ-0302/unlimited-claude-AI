<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Interface - Fully Functional</title>
    <script src="https://js.puter.com/v2/"></script>
    <!--
    ÊîπÂä®ËØ¥ÊòéÔºö
    1. Êñ∞Â¢ûÂáΩÊï∞ÔºöfetchPuterModels(), getCachedModels(), setCachedModels(), openModelModal(), closeModelModal(), filterModels()
    2. ‰øÆÊîπÂáΩÊï∞ÔºöinitializeInterface() - Ê∑ªÂä†Ê®°ÂûãÊãâÂèñÂíåÊñá‰ª∂‰∏ä‰º†ÂàùÂßãÂåñ
    3. ‰øÆÊîπÂáΩÊï∞ÔºösendMessage() - Â¢ûÂº∫Â§öÊ®°ÊÄÅÂÜÖÂÆπÂ§ÑÁêÜ
    4. DOMÊèíÂÖ•ÔºöÂú® .search-actions ‰∏≠ÊèíÂÖ• "+" ÊåâÈíÆÂíåÈöêËóèÁöÑ file input
    5. DOMÊèíÂÖ•ÔºöÈ°µÈù¢Êú´Â∞æÊ∑ªÂä†Ê®°ÂûãÈÄâÊã©ÂºπÁ™ó modal
    6. Êñ∞Â¢ûÂÖ®Â±ÄÂèòÈáèÔºöpendingFiles[], isUploadingFiles
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background-color: #1a1a1a;
            color: #e5e5e5;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: #262626;
            border-right: 1px solid #404040;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #404040;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 16px;
        }

        .back-arrow {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: #ff6b35;
            font-size: 14px;
            padding: 8px 0;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .new-chat-btn:hover {
            opacity: 0.8;
        }

        .plus-icon {
            width: 16px;
            height: 16px;
            background-color: #ff6b35;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }

        .sidebar-nav {
            padding: 16px;
            border-bottom: 1px solid #404040;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            color: #b3b3b3;
            font-size: 14px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item:hover {
            color: #fff;
        }

        .nav-icon {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        .sidebar-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 12px;
            color: #808080;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recent-items {
            min-height: 20px;
        }

        .recent-item {
            padding: 8px 0;
            color: #b3b3b3;
            font-size: 13px;
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-item:hover {
            color: #fff;
        }

        .empty-state {
            padding: 8px 0;
            text-align: center;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid #404040;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            background-color: #ff6b35;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-size: 14px;
            color: #fff;
            font-weight: 500;
        }

        .user-plan {
            font-size: 12px;
            color: #808080;
        }

        .chevron-down {
            width: 16px;
            height: 16px;
            opacity: 0.5;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #1a1a1a;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            position: relative;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 40px;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            margin-bottom: 20px;
            height: calc(100vh - 200px);
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: #404040 #262626;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #262626;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .message {
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background-color: #ff6b35;
            color: white;
        }

        .message.assistant .message-avatar {
            background-color: #4a90e2;
            color: white;
        }

        .message-content {
            max-width: 70%;
            background-color: #262626;
            border-radius: 12px;
            padding: 16px;
            color: #e5e5e5;
            line-height: 1.5;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
        .message.assistant .message-content {
            padding: 0;
        }
        .message-text-part {
            padding: 16px;
            white-space: pre-wrap;
        }

        .message.user .message-content {
            background-color: #ff6b35;
            color: white;
            padding: 16px;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #808080;
            font-style: italic;
            padding: 16px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #808080;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .greeting {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
            font-size: 32px;
            font-weight: 400;
            color: #fff;
        }

        .sun-icon {
            width: 32px;
            height: 32px;
            color: #ff6b35;
        }

        .search-container {
            width: 100%;
            max-width: 600px;
            position: relative;
            margin-bottom: 20px;
        }

        .chat-container .search-container {
            position: sticky;
            bottom: 0;
            background-color: #1a1a1a;
            padding: 20px 0;
            margin: 0;
            max-width: none;
        }

        .search-input {
            width: 100%;
            padding: 18px 80px 18px 16px;
            background-color: #262626;
            border: 1px solid #404040;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
            resize: none;
            min-height: 60px;
            max-height: 150px;
            font-family: inherit;
        }

        .search-input:focus {
            border-color: #ff6b35;
        }

        .search-input::placeholder {
            color: #808080;
        }

        .search-actions {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 4px;
        }

        .send-btn {
            padding: 10px;
            background-color: #ff6b35;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            background-color: #e55a2b;
        }

        .send-btn:disabled {
            background-color: #404040;
            cursor: not-allowed;
        }

        .model-selector {
            align-self: flex-end;
            margin-bottom: 20px;
            margin-right: 60px;
        }

        .model-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: #b3b3b3;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .model-btn:hover {
            background-color: #262626;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            justify-content: center;
            max-width: 500px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background-color: #262626;
            border: 1px solid #404040;
            border-radius: 8px;
            color: #e5e5e5;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            justify-content: center;
        }

        .action-btn:hover {
            background-color: #333;
            border-color: #555;
            transform: translateY(-1px);
        }

        .action-icon {
            width: 14px;
            height: 14px;
            opacity: 0.8;
        }

        /* Artifact Canvas Styles */
        .artifact-canvas {
            background-color: #0d0d0d;
            border: 1px solid #404040;
            border-radius: 8px;
            margin: 16px;
            overflow: hidden;
        }

        .artifact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #2a2a2a;
            padding: 8px 12px;
            border-bottom: 1px solid #404040;
        }

        .artifact-title {
            font-size: 13px;
            font-weight: 500;
            color: #b3b3b3;
        }

        .artifact-actions {
            display: flex;
            gap: 8px;
        }

        .artifact-btn {
            background: none;
            border: 1px solid #555;
            color: #b3b3b3;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .artifact-btn:hover {
            background-color: #404040;
            color: #fff;
        }

        .artifact-btn.view-btn {
            border-color: #4a90e2;
            color: #4a90e2;
        }
        .artifact-btn.view-btn:hover {
            background-color: #4a90e2;
            color: #fff;
        }

        .artifact-btn svg {
            width: 14px;
            height: 14px;
        }

        .artifact-code {
            padding: 12px;
            max-height: 400px;
            overflow: auto;
            scrollbar-width: thin;
            scrollbar-color: #404040 #1a1a1a;
        }

        .artifact-code pre {
            margin: 0;
        }

        .artifact-code code {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
            color: #e5e5e5;
            white-space: pre;
        }

        /* Name input modal */
        .name-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .name-modal.active {
            display: flex;
        }

        .name-modal-content {
            background: #262626;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
        }

        .name-modal h2 {
            color: #fff;
            margin-bottom: 8px;
            font-size: 24px;
        }

        .name-modal p {
            color: #b3b3b3;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .name-modal input {
            width: 100%;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            margin-bottom: 16px;
        }

        .name-modal input:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .name-modal button {
            width: 100%;
            padding: 12px;
            background: #ff6b35;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .name-modal button:hover {
            background: #e55a2b;
        }

        .name-modal button:disabled {
            background: #404040;
            cursor: not-allowed;
        }

        /* Model selection modal */
        .model-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .model-modal.active {
            display: flex;
        }

        .model-modal-content {
            background: #262626;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .model-modal h2 {
            color: #fff;
            margin-bottom: 16px;
            font-size: 20px;
        }

        .model-search {
            width: 100%;
            padding: 10px 12px;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .model-search:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .model-list {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #404040 #262626;
        }

        .model-list::-webkit-scrollbar {
            width: 6px;
        }

        .model-list::-webkit-scrollbar-track {
            background: #262626;
        }

        .model-list::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 3px;
        }

        .model-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .model-item:hover {
            background: #2a2a2a;
            border-color: #555;
        }

        .model-item.selected {
            background: #ff6b35;
            border-color: #ff6b35;
        }

        .model-item-name {
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            margin-bottom: 4px;
        }

        .model-item.selected .model-item-name {
            color: #fff;
        }

        .model-item-id {
            font-size: 12px;
            color: #808080;
        }

        .model-item.selected .model-item-id {
            color: rgba(255, 255, 255, 0.8);
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 240px;
            }

            .greeting {
                font-size: 24px;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
    
        /* Mobile drawer sidebar */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 86vw;
                max-width: 320px;
                transform: translateX(-100%);
                transition: transform .25s ease;
                z-index: 1001;
            }
            .sidebar.uc-open {
                transform: translateX(0);
            }

            .uc-backdrop {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,.4);
                display: none;
                z-index: 1000;
            }
            .uc-backdrop.uc-visible {
                display: block;
            }

            .uc-hamburger {
                position: fixed;
                left: 12px;
                top: 12px;
                z-index: 1100;
                background: #262626;
                color: #e5e5e5;
                border: 1px solid #404040;
                border-radius: 10px;
                padding: 8px 10px;
                cursor: pointer;
                font-size: 20px;
            }

            .content-area {
                padding: 16px;
            }
            .message-content {
                max-width: 92%;
            }
            .search-container {
                padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
            }
        }

        /* Safe area adjustments */
        :root {
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        @supports (height: 100svh) {
            html, body {
                height: 100svh;
                min-height: 100svh;
            }
        }

        .search-container, .inputbar, .composer, .chat-input-area {
            position: sticky;
            bottom: 0;
            padding-bottom: calc(12px + var(--safe-bottom));
        }

        .chat-messages, #chatMessages, .messages {
            overscroll-behavior: contain;
        }
    </style>
</head>
<body>
    <!-- Name Input Modal -->
    <div class="name-modal" id="nameModal">
        <div class="name-modal-content">
            <h2>Welcome! üëã</h2>
            <p>Please enter your name to get started</p>
            <input type="text" id="nameInput" placeholder="Your name" maxlength="30" />
            <button id="nameSubmitBtn">Continue</button>
        </div>
    </div>

    <!-- Model Selection Modal -->
    <div class="model-modal" id="modelModal">
        <div class="model-modal-content">
            <h2>Select Model</h2>
            <input type="text" class="model-search" id="modelSearch" placeholder="Search models..." />
            <div class="model-list" id="modelList"></div>
        </div>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg class="back-arrow" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                    Claude
                </div>
                <button class="new-chat-btn" id="newChatBtn">
                    <div class="plus-icon">+</div>
                    New chat
                </button>
            </div>

            <div class="sidebar-nav">
                <div class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/>
                    </svg>
                    Chats
                </div>
                <div class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    Projects
                </div>
                <div class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Artifacts
                </div>
            </div>

            <div class="sidebar-content">
                <div class="section-title">Recents</div>
                <div class="recent-items" id="recentItems">
                    <div class="empty-state" id="emptyState">
                        <span style="color: #666; font-size: 13px; font-style: italic;">No recent conversations</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatarSidebar">H</div>
                    <div class="user-details">
                        <div class="user-name" id="userNameDisplay">Hassan</div>
                        <div class="user-plan">Pro plan</div>
                    </div>
                    <svg class="chevron-down" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-area">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="greeting">
                        <svg class="sun-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
                        </svg>
                        <span id="greetingText">Good morning, Hassan</span>
                    </div>

                    <div class="search-container">
                        <textarea class="search-input" id="welcomeInput" placeholder="How can I help you today?" rows="1"></textarea>
                        <div class="search-actions">
                            <button class="model-btn" id="uploadBtnWelcome" title="Upload files">
                                <span style="font-size: 16px;">+</span>
                            </button>
                            <input type="file" id="fileInputWelcome" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.md,.csv,.json,.xml,.html,.htm,.css,.js,.zip,.rar,.7z" style="display: none;" />
                            <button class="send-btn" id="sendBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div style="max-width: 600px; margin-bottom: 15px; padding: 12px; background-color: #2a2a2a; border-radius: 8px; border: 1px solid #404040; display: none;" id="authBox">
                        <div style="font-size: 13px; color: #b3b3b3; text-align: center; margin-bottom: 10px;">
                            üí° <strong>First time?</strong> A small popup will appear for authentication - please allow it to enable free Claude access via Puter.js
                        </div>
                        <div style="font-size: 12px; color: #808080; text-align: center; margin-bottom: 10px;" id="protocolNotice"></div>
                        <div style="text-align: center;">
                            <button id="authButton" style="background-color: #ff6b35; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                üîê Authenticate with Puter
                            </button>
                        </div>
                    </div>

                    <div class="model-selector">
                        <button class="model-btn" id="modelSelector">
                            <span id="currentModel">Claude Sonnet 4</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                            </svg>
                        </button>
                    </div>

                    <div class="action-buttons">
                        <button class="action-btn" data-prompt="Help me write">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                            Write
                        </button>
                        <button class="action-btn" data-prompt="Teach me about">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6L23 9l-11-6zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/>
                            </svg>
                            Learn
                        </button>
                        <button class="action-btn" data-prompt="Help me code">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0L19.2 12l-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
                            </svg>
                            Code
                        </button>
                        <button class="action-btn" data-prompt="Help me with daily tasks">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            Life stuff
                        </button>
                    </div>
                </div>

                <!-- Chat Container -->
                <div class="chat-container" id="chatContainer">
                    <div class="chat-messages" id="chatMessages"></div>

                    <div class="typing-indicator" id="typingIndicator">
                        <div class="message-avatar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <span>Claude is typing</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>

                    <div class="search-container">
                        <textarea class="search-input" id="chatInput" placeholder="Message Claude..." rows="1"></textarea>
                        <div class="search-actions">
                            <button class="model-btn" id="uploadBtnChat" title="Upload files">
                                <span style="font-size: 16px;">+</span>
                            </button>
                            <input type="file" id="fileInputChat" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.md,.csv,.json,.xml,.html,.htm,.css,.js,.zip,.rar,.7z" style="display: none;" />
                            <button class="model-btn" id="chatModelSelector" style="padding: 6px 8px; font-size: 12px;">
                                <span id="chatCurrentModel">Sonnet 4</span>
                            </button>
                            <button class="send-btn" id="chatSendBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let availableModels = [
            { apiName: 'claude-sonnet-4', displayName: 'Claude Sonnet 4', shortName: 'Sonnet 4' },
            { apiName: 'claude-opus-4', displayName: 'Claude Opus 4', shortName: 'Opus 4' },
            { apiName: 'claude-3-7-sonnet', displayName: 'Claude 3.7 Sonnet', shortName: 'Sonnet 3.7' }
        ];
        let currentModel = availableModels[0].apiName;
        let chatHistory = [];
        let isStreaming = false;
        let recentConversations = [];
        let currentConversationId = null;
        let userName = '';
        let isAuthenticated = false;
        let pendingFiles = [];
        let isUploadingFiles = false;

        const UC_STORAGE_KEY = 'unlimitedClaude.state.v1';
        const USER_NAME_KEY = 'unlimitedClaude.userName';
        const AUTH_STATUS_KEY = 'unlimitedClaude.authStatus';
        const MODELS_CACHE_KEY = 'puterModelsCache';
        const MODELS_CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours

        // Fetch Puter models dynamically
        async function fetchPuterModels() {
            try {
                console.log('üîÑ Fetching Puter models...');
                
                // Try Puter SDK first
                if (typeof puter !== 'undefined' && puter.ai && puter.ai.models && puter.ai.models.list) {
                    try {
                        const models = await puter.ai.models.list();
                        if (models && models.length > 0) {
                            console.log('‚úÖ Fetched models via SDK:', models.length);
                            return models.map(m => ({
                                apiName: m.id || m.name,
                                displayName: formatModelName(m.id || m.name),
                                shortName: getShortName(m.id || m.name)
                            }));
                        }
                    } catch (sdkError) {
                        console.warn('SDK fetch failed, trying HTTP:', sdkError);
                    }
                }

                // Fallback to HTTP
                const response = await fetch('https://api.puter.com/puterai/chat/models');
                if (!response.ok) throw new Error('HTTP fetch failed');
                
                const data = await response.json();
                const modelsList = data.models || data;
                
                if (Array.isArray(modelsList) && modelsList.length > 0) {
                    console.log('‚úÖ Fetched models via HTTP:', modelsList.length);
                    return modelsList.map(m => ({
                        apiName: typeof m === 'string' ? m : (m.id || m.name),
                        displayName: formatModelName(typeof m === 'string' ? m : (m.id || m.name)),
                        shortName: getShortName(typeof m === 'string' ? m : (m.id || m.name))
                    }));
                }
                
                throw new Error('No models in response');
            } catch (error) {
                console.error('‚ùå Failed to fetch Puter models:', error);
                return null;
            }
        }

        function formatModelName(apiName) {
            if (!apiName) return 'Unknown Model';
            return apiName
                .replace(/-/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase())
                .replace(/\s+/g, ' ')
                .trim();
        }

        function getShortName(apiName) {
            if (!apiName) return 'Model';
            const parts = apiName.split('-');
            if (parts.length >= 2) {
                return parts.slice(0, 2).map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
            }
            return apiName.charAt(0).toUpperCase() + apiName.slice(1);
        }

        function getCachedModels() {
            try {
                const cached = localStorage.getItem(MODELS_CACHE_KEY);
                if (!cached) return null;
                
                const { models, timestamp } = JSON.parse(cached);
                const age = Date.now() - timestamp;
                
                if (age < MODELS_CACHE_DURATION) {
                    console.log('‚úÖ Using cached models (age:', Math.round(age / 60000), 'minutes)');
                    return models;
                }
                console.log('‚è∞ Cache expired');
                return null;
            } catch (e) {
                console.warn('Cache read failed:', e);
                return null;
            }
        }

        function setCachedModels(models) {
            try {
                localStorage.setItem(MODELS_CACHE_KEY, JSON.stringify({
                    models,
                    timestamp: Date.now()
                }));
            } catch (e) {
                console.warn('Cache write failed:', e);
            }
        }

        async function initializeModels() {
            let models = getCachedModels();
            
            if (!models) {
                models = await fetchPuterModels();
                if (models && models.length > 0) {
                    setCachedModels(models);
                } else {
                    console.warn('‚ö†Ô∏è Using fallback models');
                    models = availableModels;
                }
            }
            
            availableModels = models;
            
            // Validate currentModel
            if (!availableModels.find(m => m.apiName === currentModel)) {
                const preferredModel = availableModels.find(m => 
                    m.apiName.includes('claude-sonnet-4.5') || 
                    m.apiName.includes('claude-sonnet-4')
                );
                currentModel = preferredModel ? preferredModel.apiName : availableModels[0].apiName;
                console.log('üîÑ Reset to available model:', currentModel);
            }
            
            updateModelDisplay();
        }

        // Model selection modal functions
        function openModelModal() {
            const modal = document.getElementById('modelModal');
            const searchInput = document.getElementById('modelSearch');
            modal.classList.add('active');
            searchInput.value = '';
            filterModels('');
            setTimeout(() => searchInput.focus(), 100);
        }

        function closeModelModal() {
            document.getElementById('modelModal').classList.remove('active');
        }

        function filterModels(searchTerm) {
            const modelList = document.getElementById('modelList');
            const term = searchTerm.toLowerCase();
            
            const filtered = availableModels.filter(m => 
                m.apiName.toLowerCase().includes(term) || 
                m.displayName.toLowerCase().includes(term)
            );
            
            modelList.innerHTML = '';
            filtered.forEach(model => {
                const item = document.createElement('div');
                item.className = 'model-item';
                if (model.apiName === currentModel) {
                    item.classList.add('selected');
                }
                
                item.innerHTML = `
                    <div class="model-item-name">${model.displayName}</div>
                    <div class="model-item-id">${model.apiName}</div>
                `;
                
                item.addEventListener('click', () => {
                    currentModel = model.apiName;
                    updateModelDisplay();
                    ucSaveState();
                    closeModelModal();
                    console.log('üîÑ Model changed to:', model.displayName);
                });
                
                modelList.appendChild(item);
            });
        }

        function ucSaveState() {
            try {
                const state = {
                    recentConversations,
                    currentConversationId,
                    currentModel
                };
                localStorage.setItem(UC_STORAGE_KEY, JSON.stringify(state));
            } catch (e) { console.warn('ucSaveState failed', e); }
        }

        function ucRestoreState() {
            try {
                const raw = localStorage.getItem(UC_STORAGE_KEY);
                if (!raw) return;
                const s = JSON.parse(raw);
                if (Array.isArray(s.recentConversations)) recentConversations = s.recentConversations;
                currentConversationId = s.currentConversationId || null;
                if (s.currentModel) currentModel = s.currentModel;

                updateModelDisplay?.();
                updateRecentItems?.();

                if (currentConversationId) {
                    const conv = recentConversations.find(c => c.id === currentConversationId);
                    if (conv) {
                        switchToChatView?.();
                        const chatMessagesEl = document.getElementById('chatMessages');
                        if (chatMessagesEl) chatMessagesEl.innerHTML = '';
                        chatHistory = [...(conv.messages || [])];
                        (conv.messages || []).forEach(msg => addMessage(msg.content, msg.role));
                    }
                }
            } catch (e) { console.warn('ucRestoreState failed', e); }
        }

        function checkUserName() {
            const savedName = localStorage.getItem(USER_NAME_KEY);
            if (savedName) {
                userName = savedName;
                updateUserDisplay();
                return true;
            }
            return false;
        }

        function saveUserName(name) {
            userName = name;
            localStorage.setItem(USER_NAME_KEY, name);
            updateUserDisplay();
        }

        function updateUserDisplay() {
            const userNameEl = document.getElementById('userNameDisplay');
            const greetingEl = document.getElementById('greetingText');
            const avatarEl = document.getElementById('userAvatarSidebar');
            
            if (userNameEl) userNameEl.textContent = userName;
            if (greetingEl) {
                const hour = new Date().getHours();
                let greeting = 'Good morning';
                if (hour >= 12 && hour < 18) greeting = 'Good afternoon';
                else if (hour >= 18) greeting = 'Good evening';
                greetingEl.textContent = `${greeting}, ${userName}`;
            }
            if (avatarEl) avatarEl.textContent = userName.charAt(0).toUpperCase();
        }

        function checkAuthStatus() {
            const authStatus = localStorage.getItem(AUTH_STATUS_KEY);
            if (authStatus === 'true') {
                isAuthenticated = true;
                const authBox = document.getElementById('authBox');
                if (authBox) authBox.style.display = 'none';
                return true;
            }
            return false;
        }

        function saveAuthStatus() {
            isAuthenticated = true;
            localStorage.setItem(AUTH_STATUS_KEY, 'true');
            const authBox = document.getElementById('authBox');
            if (authBox) authBox.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing Claude interface...');
            
            if (!checkUserName()) {
                document.getElementById('nameModal').classList.add('active');
            }
            
            if (!checkAuthStatus()) {
                const authBox = document.getElementById('authBox');
                if (authBox) authBox.style.display = 'block';
            }
            
            await initializeModels();
            initializeInterface();
            updateProtocolNotice();
            ucRestoreState();
        });

        function updateProtocolNotice() {
            const protocolNotice = document.getElementById('protocolNotice');
            if (protocolNotice) {
                if (window.location.protocol === 'file:') {
                    protocolNotice.innerHTML = '‚úÖ <strong>File mode:</strong> Authentication should work perfectly here!';
                    protocolNotice.style.color = '#22c55e';
                } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    protocolNotice.innerHTML = '‚ö†Ô∏è <strong>Server mode:</strong> If auth fails, browser profile issues are likely.';
                    protocolNotice.style.color = '#f59e0b';
                } else {
                    protocolNotice.innerHTML = 'üåê <strong>Web mode:</strong> Make sure popups are allowed for this domain.';
                    protocolNotice.style.color = '#3b82f6';
                }
            }
        }

        async function handleManualAuth() {
            const authButton = document.getElementById('authButton');

            try {
                if (authButton) {
                    authButton.textContent = 'üîÑ Authenticating...';
                    authButton.disabled = true;
                }

                console.log('üîê Manually triggering Puter authentication...');

                const authResponse = await puter.ai.chat("test", {model: currentModel});

                console.log('‚úÖ Raw auth response:', authResponse);

                if (authResponse && (authResponse.message?.content || authResponse.success !== false)) {
                    console.log('‚úÖ Authentication successful!');
                    if (authButton) {
                        authButton.textContent = '‚úÖ Authenticated';
                        authButton.style.backgroundColor = '#22c55e';
                    }
                    saveAuthStatus();
                } else {
                    throw new Error('Authentication response indicates failure.');
                }

            } catch (error) {
                console.error('‚ùå Manual authentication failed:', error);

                if (authButton) {
                    authButton.textContent = '‚ùå Auth Failed - Try Again';
                    authButton.disabled = false;
                    authButton.style.backgroundColor = '#dc2626';
                }

                alert('‚ö†Ô∏è Authentication failed!\n\nPlease try:\n1. Use Incognito/Private mode\n2. Disable browser extensions\n3. Allow popups for this site\n4. Clear site data for puter.com');
            }
        }

        // File upload handling
        function initializeFileUpload() {
            const uploadBtnWelcome = document.getElementById('uploadBtnWelcome');
            const uploadBtnChat = document.getElementById('uploadBtnChat');
            const fileInputWelcome = document.getElementById('fileInputWelcome');
            const fileInputChat = document.getElementById('fileInputChat');

            if (uploadBtnWelcome && fileInputWelcome) {
                uploadBtnWelcome.addEventListener('click', () => fileInputWelcome.click());
                fileInputWelcome.addEventListener('change', (e) => handleFileSelection(e.target.files));
            }

            if (uploadBtnChat && fileInputChat) {
                uploadBtnChat.addEventListener('click', () => fileInputChat.click());
                fileInputChat.addEventListener('change', (e) => handleFileSelection(e.target.files));
            }

            // Drag and drop support
            [document.getElementById('welcomeInput'), document.getElementById('chatInput')].forEach(textarea => {
                if (!textarea) return;
                
                textarea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    textarea.style.borderColor = '#ff6b35';
                });
                
                textarea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    textarea.style.borderColor = '#404040';
                });
                
                textarea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    textarea.style.borderColor = '#404040';
                    if (e.dataTransfer.files.length > 0) {
                        handleFileSelection(e.dataTransfer.files);
                    }
                });

                // Paste support
                textarea.addEventListener('paste', (e) => {
                    const items = e.clipboardData?.items;
                    if (items) {
                        const files = [];
                        for (let i = 0; i < items.length; i++) {
                            if (items[i].kind === 'file') {
                                files.push(items[i].getAsFile());
                            }
                        }
                        if (files.length > 0) {
                            e.preventDefault();
                            handleFileSelection(files);
                        }
                    }
                });
            });
        }

        async function handleFileSelection(fileList) {
            if (!fileList || fileList.length === 0) return;
            
            pendingFiles = Array.from(fileList);
            console.log('üìé Files selected:', pendingFiles.length);
            
            // Update UI to show file count
            const welcomeInput = document.getElementById('welcomeInput');
            const chatInput = document.getElementById('chatInput');
            const activeInput = document.getElementById('chatContainer').classList.contains('active') ? chatInput : welcomeInput;
            
            if (activeInput && !activeInput.value.trim()) {
                activeInput.placeholder = `üìé ${pendingFiles.length} file(s) attached - add message or press send`;
            }
        }

        function initializeInterface() {
            const welcomeInput = document.getElementById('welcomeInput');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const newChatBtn = document.getElementById('newChatBtn');
            const actionBtns = document.querySelectorAll('.action-btn');
            const modelSelectors = document.querySelectorAll('#modelSelector, #chatModelSelector');
            const authButton = document.getElementById('authButton');
            const nameSubmitBtn = document.getElementById('nameSubmitBtn');
            const nameInput = document.getElementById('nameInput');
            const modelSearch = document.getElementById('modelSearch');
            const modelModal = document.getElementById('modelModal');

            if (authButton) authButton.addEventListener('click', handleManualAuth);

            if (nameSubmitBtn) {
                nameSubmitBtn.addEventListener('click', function() {
                    const name = nameInput.value.trim();
                    if (name) {
                        saveUserName(name);
                        document.getElementById('nameModal').classList.remove('active');
                    }
                });
            }

            if (nameInput) {
                nameInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        const name = nameInput.value.trim();
                        if (name) {
                            saveUserName(name);
                            document.getElementById('nameModal').classList.remove('active');
                        }
                    }
                });
            }

            // Model selection
            modelSelectors.forEach(selector => {
                if (selector) selector.addEventListener('click', openModelModal);
            });

            if (modelSearch) {
                modelSearch.addEventListener('input', (e) => filterModels(e.target.value));
            }

            if (modelModal) {
                modelModal.addEventListener('click', (e) => {
                    if (e.target === modelModal) closeModelModal();
                });
            }

            [welcomeInput, chatInput].forEach(textarea => {
                if (textarea) {
                    textarea.addEventListener('input', () => autoResize(textarea));
                    textarea.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            if (textarea === welcomeInput) handleWelcomeMessage();
                            else handleChatMessage();
                        }
                    });
                }
            });

            if (sendBtn) sendBtn.addEventListener('click', handleWelcomeMessage);
            if (chatSendBtn) chatSendBtn.addEventListener('click', handleChatMessage);
            if (newChatBtn) newChatBtn.addEventListener('click', startNewChat);

            actionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const prompt = this.getAttribute('data-prompt');
                    if (prompt && welcomeInput) {
                        welcomeInput.value = prompt;
                        welcomeInput.focus();
                        autoResize(welcomeInput);
                    }
                });
            });

            initializeFileUpload();

            if (welcomeInput) welcomeInput.focus();
            console.log('‚úÖ Interface initialized');
        }

        function updateModelDisplay() {
            const model = availableModels.find(m => m.apiName === currentModel);
            if (!model) {
                console.error("Model not found in available models:", currentModel);
                return;
            }
            document.getElementById('currentModel').textContent = model.displayName;
            document.getElementById('chatCurrentModel').textContent = model.shortName;
        }

        async function handleWelcomeMessage() {
            const welcomeInput = document.getElementById('welcomeInput');
            const message = welcomeInput.value.trim();
            if ((!message && pendingFiles.length === 0) || isStreaming) return;
            console.log('üì§ Sending welcome message:', message);
            createNewConversation(message || `üìé ${pendingFiles.length} file(s)`);
            switchToChatView();
            await sendMessage(message);
        }

        async function handleChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if ((!message && pendingFiles.length === 0) || isStreaming) return;
            console.log('üì§ Sending chat message:', message);
            chatInput.value = '';
            autoResize(chatInput);
            await sendMessage(message);
        }

        function createNewConversation(firstMessage) {
            currentConversationId = 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const title = firstMessage.length > 50 ? firstMessage.substring(0, 50) + '...' : firstMessage;
            const conversation = {
                id: currentConversationId,
                title: title,
                messages: [],
                timestamp: new Date(),
                model: currentModel
            };
            recentConversations.unshift(conversation);
            if (recentConversations.length > 10) {
                recentConversations = recentConversations.slice(0, 10);
            }
            updateRecentItems();
            ucSaveState();
            console.log('üìÅ Created new conversation:', title);
        }

        function updateRecentItems() {
            const recentItemsContainer = document.getElementById('recentItems');
            recentItemsContainer.innerHTML = '';
            if (recentConversations.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.innerHTML = '<span style="color: #666; font-size: 13px; font-style: italic;">No recent conversations</span>';
                recentItemsContainer.appendChild(emptyDiv);
            } else {
                recentConversations.forEach(conversation => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'recent-item';
                    itemDiv.textContent = conversation.title;
                    itemDiv.addEventListener('click', () => loadConversation(conversation.id));
                    recentItemsContainer.appendChild(itemDiv);
                });
            }
        }

        function loadConversation(conversationId) {
            const conversation = recentConversations.find(conv => conv.id === conversationId);
            if (!conversation) return;
            currentConversationId = conversationId;
            chatHistory = [...conversation.messages];
            currentModel = conversation.model;
            updateModelDisplay();
            switchToChatView();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            conversation.messages.forEach(msg => {
                addMessage(msg.content, msg.role);
            });
            document.getElementById('chatInput').focus();
            console.log('üìÇ Loaded conversation:', conversation.title);
        }

        function switchToChatView() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('chatContainer').classList.add('active');
            console.log('üîÑ Switched to chat view');
        }

        function startNewChat() {
            chatHistory = [];
            currentConversationId = null;
            pendingFiles = [];

            currentModel = availableModels[0].apiName;
            updateModelDisplay();

            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatContainer = document.getElementById('chatContainer');
            const chatMessages = document.getElementById('chatMessages');
            const welcomeInput = document.getElementById('welcomeInput');

            if (welcomeScreen) welcomeScreen.style.display = 'flex';
            if (chatContainer) chatContainer.classList.remove('active');
            if (chatMessages) chatMessages.innerHTML = '';
            if (welcomeInput) {
                welcomeInput.value = '';
                welcomeInput.placeholder = 'How can I help you today?';
                autoResize(welcomeInput);
                welcomeInput.focus();
            }
            autoResize(document.getElementById('chatInput'));

            console.log('üÜï Started new chat, model reset to default.');
            ucSaveState();
        }

        async function processFiles(files) {
            const processed = [];
            const textSummaries = [];
            const imagePaths = [];

            for (const file of files) {
                const fileName = file.name;
                const fileType = file.type;
                const fileSize = (file.size / 1024).toFixed(2) + ' KB';
                
                console.log(`üìÑ Processing: ${fileName} (${fileType}, ${fileSize})`);

                // Text files
                if (fileType.startsWith('text/') || 
                    fileType === 'application/json' || 
                    fileType === 'application/xml' ||
                    /\.(txt|md|csv|json|xml|html|htm|css|js)$/i.test(fileName)) {
                    
                    try {
                        let content = await file.text();
                        const maxLength = 120000;
                        
                        if (content.length > maxLength) {
                            content = content.substring(0, maxLength) + '\n\n[Content truncated...]';
                        }
                        
                        const isHTML = /\.html?$/i.test(fileName) || fileType === 'text/html';
                        const codeBlock = isHTML ? '```html\n' + content + '\n```' : content;
                        
                        textSummaries.push(`\nüìÑ **${fileName}** (${fileType}, ${fileSize}):\n${codeBlock}`);
                    } catch (err) {
                        console.error('Failed to read text file:', err);
                        textSummaries.push(`\nüìÑ **${fileName}** (${fileType}, ${fileSize}): [Failed to read]`);
                    }
                }
                // Image files
                else if (fileType.startsWith('image/')) {
                    try {
                        if (typeof puter !== 'undefined' && puter.fs && puter.fs.upload) {
                            const uploadResult = await puter.fs.upload(file);
                            if (uploadResult && uploadResult.path) {
                                imagePaths.push({
                                    type: 'file',
                                    puter_path: uploadResult.path
                                });
                                textSummaries.push(`\nüñºÔ∏è **${fileName}** (${fileType}, ${fileSize}) - Uploaded to: ${uploadResult.path}`);
                            } else {
                                textSummaries.push(`\nüñºÔ∏è **${fileName}** (${fileType}, ${fileSize}) - [Upload returned no path]`);
                            }
                        } else {
                            textSummaries.push(`\nüñºÔ∏è **${fileName}** (${fileType}, ${fileSize}) - [Puter upload not available]`);
                        }
                    } catch (err) {
                        console.error('Failed to upload image:', err);
                        textSummaries.push(`\nüñºÔ∏è **${fileName}** (${fileType}, ${fileSize}) - [Upload failed]`);
                    }
                }
                // Binary files (docs, videos, audio, archives)
                else {
                    try {
                        if (typeof puter !== 'undefined' && puter.fs && puter.fs.upload) {
                            const uploadResult = await puter.fs.upload(file);
                            if (uploadResult && uploadResult.path) {
                                textSummaries.push(`\nüì¶ **${fileName}** (${fileType}, ${fileSize}) - Uploaded to: ${uploadResult.path}`);
                            } else {
                                textSummaries.push(`\nüì¶ **${fileName}** (${fileType}, ${fileSize}) - [Upload returned no path]`);
                            }
                        } else {
                            textSummaries.push(`\nüì¶ **${fileName}** (${fileType}, ${fileSize}) - [Binary file, upload not available]`);
                        }
                    } catch (err) {
                        console.error('Failed to upload binary file:', err);
                        textSummaries.push(`\nüì¶ **${fileName}** (${fileType}, ${fileSize}) - [Upload failed]`);
                    }
                }
            }

            return {
                textSummaries: textSummaries.join('\n'),
                imagePaths
            };
        }

        async function sendMessage(message) {
            if (isStreaming) return;

            console.log('üöÄ Starting to send message...');
            
            const hasFiles = pendingFiles.length > 0;
            const userMessage = message.trim() || (hasFiles ? 'Please analyze the attached file(s) and describe key details.' : '');
            
            let displayMessage = userMessage;
            if (hasFiles) {
                displayMessage = `üìé Sent ${pendingFiles.length} file(s)\n${userMessage}`;
            }
            
            addMessage(displayMessage, 'user');
            showTypingIndicator();
            setInputState(false);

            // Process files if any
            let fileContent = null;
            if (hasFiles) {
                try {
                    isUploadingFiles = true;
                    fileContent = await processFiles(pendingFiles);
                } catch (err) {
                    console.error('File processing error:', err);
                } finally {
                    isUploadingFiles = false;
                    pendingFiles = [];
                    
                    // Reset placeholders
                    const welcomeInput = document.getElementById('welcomeInput');
                    const chatInput = document.getElementById('chatInput');
                    if (welcomeInput) welcomeInput.placeholder = 'How can I help you today?';
                    if (chatInput) chatInput.placeholder = 'Message Claude...';
                }
            }

            // Build message content
            let messageContent = userMessage;
            if (fileContent && fileContent.textSummaries) {
                messageContent = fileContent.textSummaries + '\n\n' + userMessage;
            }

            chatHistory.push({ role: 'user', content: messageContent });

            try {
                isStreaming = true;
                if (typeof puter === 'undefined') { 
                    throw new Error('Puter.js is not available.'); 
                }
                
                console.log('üì° Calling Puter AI with model:', currentModel);

                // Strategy A: Try with all files
                let response = null;
                let strategyUsed = 'A';
                
                try {
                    const requestPayload = fileContent && fileContent.imagePaths.length > 0 
                        ? [...chatHistory, ...fileContent.imagePaths.map(img => ({ role: 'user', content: [img] }))]
                        : chatHistory;
                    
                    response = await puter.ai.chat(requestPayload, {
                        model: currentModel,
                        stream: true
                    });
                } catch (errA) {
                    console.warn('Strategy A failed, trying B:', errA);
                    strategyUsed = 'B';
                    
                    // Strategy B: Images only
                    try {
                        response = await puter.ai.chat(chatHistory, {
                            model: currentModel,
                            stream: true
                        });
                    } catch (errB) {
                        console.warn('Strategy B failed, trying C:', errB);
                        strategyUsed = 'C';
                        
                        // Strategy C: Pure text only
                        response = await puter.ai.chat(chatHistory, {
                            model: currentModel,
                            stream: true
                        });
                    }
                }

                console.log('‚úÖ Using strategy:', strategyUsed);

                if (response && response.success === false) {
                    throw new Error('Authentication required. Please click the authenticate button and allow the popup.');
                }

                saveAuthStatus();

                const { messageContent: msgContent } = addMessage('', 'assistant');
                hideTypingIndicator();
                let fullResponse = '';

                for await (const part of response) {
                    // Handle multiple response formats
                    const text = part?.text || part?.delta?.text || part?.content?.[0]?.text || '';
                    
                    if (text) {
                        fullResponse += text;
                        renderFormattedMessage(fullResponse, msgContent);
                        scrollToBottom();
                    }
                }

                console.log('‚úÖ Streaming complete.');
                renderFormattedMessage(fullResponse, msgContent);

                chatHistory.push({ role: 'assistant', content: fullResponse });
                updateCurrentConversation();

            } catch (error) {
                console.error('‚ùå Error in sendMessage:', error);
                hideTypingIndicator();
                addMessage('Sorry, I encountered an error: ' + (error.message || 'Unknown error.'), 'assistant', true);

                if (chatHistory.length > 0 && chatHistory[chatHistory.length - 1].role === 'user') {
                    chatHistory.pop();
                }

            } finally {
                isStreaming = false;
                setInputState(true);
                document.getElementById('chatInput')?.focus();
            }
        }

        function updateCurrentConversation() {
            if (!currentConversationId) return;
            const conversation = recentConversations.find(conv => conv.id === currentConversationId);
            if (conversation) {
                conversation.messages = [...chatHistory];
                conversation.timestamp = new Date();
                const index = recentConversations.indexOf(conversation);
                if (index > 0) {
                    recentConversations.splice(index, 1);
                    recentConversations.unshift(conversation);
                    updateRecentItems();
                }
            }
            ucSaveState();
        }

        function addMessage(content, role, isError = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.setAttribute('data-message-id', messageId);

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = role === 'user' ? userName.charAt(0).toUpperCase() : `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>`;

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            if (role === 'assistant') renderFormattedMessage(content, messageContent);
            else messageContent.textContent = content;

            if (isError) messageContent.style.color = '#ff6b6b';

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);

            scrollToBottom();
            return { messageId, messageContent };
        }

        function renderFormattedMessage(content, container) {
            container.innerHTML = '';
            const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
            let lastIndex = 0;
            let match;

            while ((match = codeBlockRegex.exec(content)) !== null) {
                if (match.index > lastIndex) {
                    const textPart = document.createElement('div');
                    textPart.className = 'message-text-part';
                    textPart.textContent = content.substring(lastIndex, match.index);
                    container.appendChild(textPart);
                }

                const [fullMatch, language, code] = match;
                container.appendChild(createArtifactCanvas(code.trim(), language || 'text'));
                lastIndex = match.index + fullMatch.length;
            }

            if (lastIndex < content.length) {
                const textPart = document.createElement('div');
                textPart.className = 'message-text-part';
                textPart.textContent = content.substring(lastIndex);
                container.appendChild(textPart);
            }

            if (container.children.length === 0 && content) {
                const textPart = document.createElement('div');
                textPart.className = 'message-text-part';
                textPart.textContent = content;
                container.appendChild(textPart);
            }
        }

        function createArtifactCanvas(code, language) {
            const canvas = document.createElement('div');
            canvas.className = 'artifact-canvas';

            const header = document.createElement('div');
            header.className = 'artifact-header';

            const title = document.createElement('div');
            title.className = 'artifact-title';
            title.textContent = language ? `${language} code` : 'Code Artifact';

            const actions = document.createElement('div');
            actions.className = 'artifact-actions';

            if (language.toLowerCase() === 'html') {
                const viewBtn = document.createElement('button');
                viewBtn.className = 'artifact-btn view-btn';
                viewBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> View`;
                viewBtn.onclick = () => {
                    const blob = new Blob([code], { type: 'text/html' });
                    window.open(URL.createObjectURL(blob), '_blank');
                };
                actions.appendChild(viewBtn);
            }

            const copyBtn = document.createElement('button');
            copyBtn.className = 'artifact-btn';
            const copyIcon = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> Copy`;
            copyBtn.innerHTML = copyIcon;
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(code).then(() => {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => { copyBtn.innerHTML = copyIcon; }, 2000);
                });
            };

            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'artifact-btn';
            downloadBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> Download`;
            downloadBtn.onclick = () => {
                const extensionMap = { javascript: 'js', python: 'py', html: 'html', css: 'css', json: 'json', java: 'java', csharp: 'cs', cpp: 'cpp', ruby: 'rb', go: 'go', rust: 'rs', shell: 'sh', bash: 'sh' };
                const extension = extensionMap[language.toLowerCase()] || 'txt';
                const filename = `claude-code.${extension}`;
                const blob = new Blob([code], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
                a.remove();
            };

            actions.appendChild(copyBtn);
            actions.appendChild(downloadBtn);
            header.appendChild(title);
            header.appendChild(actions);

            const codeArea = document.createElement('div');
            codeArea.className = 'artifact-code';
            const pre = document.createElement('pre');
            const codeEl = document.createElement('code');
            codeEl.textContent = code;
            pre.appendChild(codeEl);
            codeArea.appendChild(pre);

            canvas.appendChild(header);
            canvas.appendChild(codeArea);

            return canvas;
        }

        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'flex';
                scrollToBottom();
            }
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function setInputState(enabled) {
            const inputs = [
                document.getElementById('welcomeInput'),
                document.getElementById('chatInput'),
                document.getElementById('sendBtn'),
                document.getElementById('chatSendBtn')
            ];
            inputs.forEach(input => {
                if (input) {
                    input.disabled = !enabled;
                    input.style.opacity = enabled ? '1' : '0.6';
                }
            });
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                requestAnimationFrame(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }
        }

        function autoResize(textarea) {
            if (!textarea) return;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
    </script>

    <script>
    (function(){
        function getChatList(){
            return document.getElementById('chatMessages')
                || document.querySelector('.chat-messages')
                || document.querySelector('#messages')
                || document.querySelector('.messages');
        }
        function scrollToBottom(smooth){
            var el = getChatList();
            if(!el) return;
            try {
                el.scrollTo({ top: el.scrollHeight, behavior: smooth ? 'smooth' : 'auto' });
            } catch(e) {
                el.scrollTop = el.scrollHeight;
            }
        }
        var list = getChatList();
        if(list){
            var nearBottom = function(){
                try { return (list.scrollHeight - list.scrollTop - list.clientHeight) < 120; }
                catch(e){ return true; }
            };
            var mo = new MutationObserver(function(){
                if (nearBottom()) scrollToBottom(false);
            });
            mo.observe(list, { childList: true, subtree: true });
        }

        function adjustSafeArea(){
            var input = document.querySelector('.search-container, .inputbar, .composer, .chat-input-area');
            if(input){
                input.style.paddingBottom = 'calc(12px + env(safe-area-inset-bottom, 0px))';
            }
        }
        window.addEventListener('resize', adjustSafeArea, { passive: true });
        document.addEventListener('DOMContentLoaded', adjustSafeArea);
        setTimeout(adjustSafeArea, 500);
    })();
    </script>

    <button id="ucToggleSidebar" class="uc-hamburger" aria-label="Toggle menu">‚ò∞</button>
    <div id="ucSidebarBackdrop" class="uc-backdrop"></div>

    <script>
    (function(){
        function setupUCDrawer(){
            var sidebar = document.querySelector('.sidebar');
            var btn = document.getElementById('ucToggleSidebar');
            var backdrop = document.getElementById('ucSidebarBackdrop');
            if(!sidebar || !btn || !backdrop) return;

            var open = function(){ sidebar.classList.add('uc-open'); backdrop.classList.add('uc-visible'); };
            var close = function(){ sidebar.classList.remove('uc-open'); backdrop.classList.remove('uc-visible'); };

            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (sidebar.classList.contains('uc-open')) {
                    close();
                } else {
                    open();
                }
            });
            backdrop.addEventListener('click', close);
            document.getElementById('chatSendBtn')?.addEventListener('click', close);
            document.getElementById('sendBtn')?.addEventListener('click', close);
            document.getElementById('newChatBtn')?.addEventListener('click', close);
            document.getElementById('recentItems')?.addEventListener('click', close);
        }
        if (document.readyState !== 'loading') setupUCDrawer();
        else document.addEventListener('DOMContentLoaded', setupUCDrawer);
    })();
    </script>

</body>
</html>